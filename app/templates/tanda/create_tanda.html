{% extends "base.html" %}
{% block title %}Create Tanda{% endblock %}
{% block content %}
<h1>Create a New Tanda</h1>
<form method="post">
    {{ form.hidden_tag() }}
    <div class="form-group">
        {{ form.name.label(class="form-label") }}
        {{ form.name(class="form-control") }}
    </div>
    <div class="form-group">
        {{ form.tanda_type_id.label(class="form-label") }}
        {{ form.tanda_type_id(class="form-control") }}
    </div>
    <div class="form-group">
        {{ form.comments.label(class="form-label") }}
        {{ form.comments(class="form-control") }}
    </div>
    <div class="form-group">
        {{ form.spotify_link.label(class="form-label") }}
        {{ form.spotify_link(class="form-control") }}
    </div>
    <div class="form-group">
        {{ form.youtube_link.label(class="form-label") }}
        {{ form.youtube_link(class="form-control") }}
    </div>

    <!-- Song Selection -->
    <div class="form-group">
        <label for="song-search">Add Songs to Tanda:</label>
        <input type="text" id="song-search" class="form-control" placeholder="Search for songs...">
        <div id="song-search-results" class="list-group"></div>
    </div>
    <div class="form-group">
        <label>Selected Songs:</label>
        <ul id="selected-songs" class="list-group"></ul>
    </div>
    {{ form.song_ids() }}

    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    <a href="{{ url_for('tanda_bp.list_tandas') }}" class="btn btn-secondary">Cancel</a>
</form>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const songSearchInput = document.getElementById('song-search');
    const songSearchResults = document.getElementById('song-search-results');
    const selectedSongs = document.getElementById('selected-songs');
    const songIdsField = document.getElementById('song_ids');

    let selectedSongIds = [];

    songSearchInput.addEventListener('input', function() {
        const query = songSearchInput.value;
        if (query.length < 2) {
            songSearchResults.innerHTML = '';
            return;
        }
        fetch(`/tandas/search_songs?q=${query}`)
            .then(response => response.json())
            .then(data => {
                songSearchResults.innerHTML = '';
                data.forEach(song => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = `${song.title} (${song.orchestra})`;
                    item.dataset.songId = song.id;
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        addSongToTanda(song);
                    });
                    songSearchResults.appendChild(item);
                });
            });
    });

    function addSongToTanda(song) {
        if (selectedSongIds.includes(song.id.toString())) {
            alert('Song already added.');
            return;
        }
        selectedSongIds.push(song.id.toString());
        const item = document.createElement('li');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.textContent = `${song.title} (${song.orchestra})`;
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-sm btn-danger';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', function() {
            selectedSongs.removeChild(item);
            selectedSongIds = selectedSongIds.filter(id => id !== song.id.toString());
            updateSongIdsField();
        });
        item.appendChild(removeBtn);
        selectedSongs.appendChild(item);
        updateSongIdsField();
    }

    function updateSongIdsField() {
        songIdsField.value = selectedSongIds.join(',');
    }
});
</script>
{% endblock %}
{% endblock %}
